# Состояние Alembic-миграций

## Цель

Обеспечить:

- **Линейный граф миграций** (без multiple heads).
- **Идемпотентность** миграций, чтобы:
  - их можно было безопасно прогонять повторно;
  - `db-init` в Docker мог работать и на пустой, и на уже существующей БД.
- Добавить таблицу `task_issue_links` для идемпотентной синхронизации задач в Redmine.

---

## Цепочка миграций

Текущая логическая цепочка (по `revision` / `down_revision`):

1. `0001_initial`
2. `0002_add_task_deleted`
3. `0003_add_task_timestamps`
4. `0004_expand_task_fields`
5. `0005_add_webhook_event_timestamp`
6. `0006_add_task_issue_links`

Все последующие миграции идут **строгой линейкой**, без разветвлений.

---

## Изменённые существующие миграции

### 0002_add_task_deleted

- Добавляет поле `deleted` в таблицу `tasks`.
- Сделана **идемпотентной**:
  - при `upgrade()` колонка добавляется **только если её ещё нет**;
  - при `downgrade()` колонка удаляется **только если она есть**.

### 0003_add_task_timestamps

- Добавляет поля `created_at`, `completed_at`, `archived_at` в `tasks`.
- Сделана **идемпотентной**:
  - при `upgrade()` каждое поле добавляется только при отсутствии;
  - при `downgrade()` каждое поле удаляется только при наличии.

### 0004_expand_task_fields

- Добавляет расширенный набор полей в `tasks` (доп. атрибуты задачи).
- Также приведена к **идемпотентному** виду:
  - при `upgrade()` каждое дополнительное поле проверяется на существование перед добавлением;
  - при `downgrade()` каждый столбец удаляется только если он реально существует.

### 0005_add_webhook_event_timestamp

- Добавляет столбец `event_timestamp` в таблицу `webhook_events`.
- Уже содержала проверку существования таблицы, поэтому:
  - миграция по сути **уже была идемпотентной**;
  - оставлена по смыслу без изменений, при необходимости — с аккуратными проверками.

---

## Новая миграция: 0006_add_task_issue_links

Создана новая миграция `0006_add_task_issue_links.py` (revision: `0006_add_task_issue_links`, `down_revision = "0005_add_webhook_event_timestamp"`).

### Назначение

- Вводит таблицу `task_issue_links`, которая связывает задачи YouGile и задачи Redmine.
- Используется сервисом `redmine_task_sync` для **идемпотентной синхронизации**:
  - при повторном запуске синка по той же задаче вместо создания нового issue в Redmine происходит обновление существующего.

### Структура таблицы (логически)

- `id` — первичный ключ.
- `task_id` — идентификатор задачи YouGile (FK на `tasks.id`).
- `issue_id` — идентификатор issue в Redmine (целое число).
- Дополнительные служебные поля (например, дата создания связи).
- Индексы/ограничения для обеспечения уникальности связи задача ↔ issue.

Миграция включена в общую линейную цепочку и **автоматически применяется** при `alembic upgrade head` и при запуске `db-init` в Docker.

---

## Поведение `db-init` в Docker

Скрипт `docker/db-init.sh`:

- Работает **автоматически** при старте контейнера `db-init` (см. `docker-compose.yml`).
- Логика:
  - если БД пустая и таблицы миграций ещё нет — выполняется `alembic stamp` на базовую ревизию, затем `alembic upgrade head`;
  - если БД уже содержит таблицу миграций — просто выполняется `alembic upgrade head`.

Благодаря идемпотентности всех новых/изменённых миграций:

- один и тот же `db-init` безопасно запускается повторно;
- миграции не падают на уже изменённой схеме (нет `DuplicateColumnError` и `Multiple head revisions`).

---

## Итог

- Граф миграций **линейный**, без конфликтующих head-ревизий.
- Все проблемные миграции (`0002`, `0003`, `0004`) приведены к **идемпотентному** виду.
- Добавлена миграция `0006_add_task_issue_links` для таблицы `task_issue_links`, используемой в `redmine_task_sync` для идемпотентного create/update задач в Redmine.
- Скрипт `db-init` в Docker теперь может стабильно применять все миграции и на чистой БД, и на уже существующей, без ручных команд Alembic.

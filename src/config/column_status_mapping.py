"""
Маппинг колонок YouGile в статусы Redmine.

Основан на документе yougile-columns-to-redmine-statuses.md
Статусы Redmine: Новая, В работе, Решена, Нужен отклик, Закрыта, Отклонена, Согласовано
"""

# Маппинг колонок YouGile → статусы Redmine
# Ключи - точные названия колонок из YouGile (без нормализации)
COLUMN_TO_STATUS = {
    # Группа 1: Новые / очередь → "Новая"
    "Новая колонка": "Новая",
    "Новые задачи": "Новая",
    "Новое": "Новая",
    "План": "Новая",
    "В очереди": "Новая",
    
    # Группа 2: В работе → "В работе"
    "В работе": "В работе",
    "В работе без срока": "В работе",
    
    # Группа 3: Тестирование → "Нужен отклик"
    "Тестирование": "Нужен отклик",
    "Тестирование (проверка)": "Нужен отклик",
    
    # Группа 4: Завершено → "Решена"
    "Выполнено": "Решена",
    "Готово": "Решена",
    
    # Группа 5: Согласовано → "Согласовано" (отдельный статус)
    "Согласовано": "Согласовано",
    
    # Группа 6: Отменено / отклонено → "Отклонена"
    "Отклонено": "Отклонена",
    "Отклоненные задачи": "Отклонена",
    "Аннулировано": "Отклонена",
    
    # Служебные и тематические колонки → "База знаний"
    "База знаний": "База знаний",
}

# Статус по умолчанию для неизвестных колонок
DEFAULT_STATUS = "Новая"

# Список всех доступных статусов Redmine
REDMINE_STATUSES = [
    "Новая",
    "В работе",
    "Решена",
    "Нужен отклик",
    "Закрыта",
    "Отклонена",
    "Согласовано",
    "База знаний",
]


def get_redmine_status(yougile_column_name: str) -> str:
    """Получить статус Redmine для колонки YouGile.

    Сначала пробуем точное совпадение по словарю COLUMN_TO_STATUS. Если не
    нашли, используем простые эвристики по подстрокам (без учёта регистра),
    чтобы корректно обрабатывать варианты вроде «В работе (без срока)» и т.п.
    """

    name = (yougile_column_name or "").strip()
    if not name:
        return DEFAULT_STATUS

    # 1. Точное совпадение (как было раньше)
    if name in COLUMN_TO_STATUS:
        return COLUMN_TO_STATUS[name]

    low = name.lower()

    # 2. Эвристики по подстрокам
    if any(sub in low for sub in ("откл", "аннули")):
        return "Отклонена"

    if "соглас" in low:
        return "Согласовано"

    if any(sub in low for sub in ("тест", "qa")):
        return "Нужен отклик"

    if any(sub in low for sub in ("выполн", "готов", "done")):
        return "Решена"

    if "работ" in low:
        return "В работе"

    if any(sub in low for sub in ("нов", "очеред")):
        return "Новая"

    # 3. По умолчанию – Новая
    return DEFAULT_STATUS


def is_valid_redmine_status(status: str) -> bool:
    """
    Проверить, является ли статус валидным для Redmine.
    
    Args:
        status: Название статуса
        
    Returns:
        True, если статус валиден
    """
    return status in REDMINE_STATUSES
